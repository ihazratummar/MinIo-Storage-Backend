<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinIO Admin</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 h-screen flex flex-col">

    <div id="app" v-cloak class="h-full flex flex-col">
        <!-- Toast Notifications -->
        <div class="fixed top-5 right-5 z-50 flex flex-col gap-2">
            <transition-group name="toast">
                <div v-for="toast in toasts" :key="toast.id" :class="['px-4 py-3 rounded-lg shadow-lg text-sm font-medium transform transition-all duration-300 flex items-center gap-2', 
                              toast.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white']">
                    <span>{{ toast.message }}</span>
                </div>
            </transition-group>
        </div>

        <!-- Login Screen -->
        <div v-if="!isAuthenticated" class="flex-1 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl border border-gray-100">
                <div class="text-center mb-8">
                    <div
                        class="bg-blue-600 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                            </path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900">Admin Access</h1>
                    <p class="text-gray-500 mt-2 text-sm">Enter your secret key to manage projects</p>
                </div>
                <form @submit.prevent="login" class="space-y-4">
                    <div>
                        <!-- Hidden username for password manager support -->
                        <input type="text" name="username" value="admin" autocomplete="username" style="display:none">

                        <input type="password" name="password" v-model="secretInput" placeholder="Admin Secret"
                            autocomplete="current-password"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                            autofocus>
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors shadow-md shadow-blue-200">
                        Unlock Dashboard
                    </button>
                </form>
            </div>
        </div>

        <!-- Dashboard -->
        <div v-else class="flex-1 flex flex-col max-w-6xl mx-auto w-full p-4 sm:p-8">
            <!-- Header -->
            <header class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center shadow-md">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Projects</h1>
                        <p class="text-gray-500 text-sm">Manage your multi-tenant storage</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button @click="logout"
                        class="px-4 py-2 text-gray-600 hover:text-gray-900 font-medium transition-colors">
                        Logout
                    </button>
                    <button @click="showCreateModal = true"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium shadow-md shadow-blue-200 transition-all flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        New Project
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex-1 flex flex-col">
                <!-- Desktop Table View -->
                <div class="hidden md:block overflow-x-auto flex-1">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr
                                class="bg-gray-50 border-b border-gray-100 text-xs uppercase text-gray-500 font-semibold tracking-wider">
                                <th class="px-6 py-4">Project Name</th>
                                <th class="px-6 py-4">Project ID</th>
                                <th class="px-6 py-4">API Key</th>
                                <th class="px-6 py-4 text-center">Buckets</th>
                                <th class="px-6 py-4 text-center">Files</th>
                                <th class="px-6 py-4 text-center">Storage</th>
                                <th class="px-6 py-4 text-right">Created</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr v-if="loading" class="animate-pulse">
                                <td colspan="8" class="px-6 py-8 text-center text-gray-400">Loading projects...</td>
                            </tr>
                            <tr v-else-if="projects.length === 0">
                                <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                    <div class="flex flex-col items-center gap-2">
                                        <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                            </path>
                                        </svg>
                                        <p>No projects found. Create one to get started.</p>
                                    </div>
                                </td>
                            </tr>
                            <tr v-for="project in projects" :key="project._id"
                                class="hover:bg-gray-50 transition-colors group">
                                <td class="px-6 py-4 font-medium text-gray-900">{{ project.name }}</td>
                                <td class="px-6 py-4 text-gray-500 font-mono text-xs">{{ project._id }}</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2 group/key">
                                        <code
                                            class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600 font-mono truncate max-w-[150px]">{{ project.api_key }}</code>
                                        <button @click="copyToClipboard(project.api_key)"
                                            class="text-gray-400 hover:text-blue-600 opacity-0 group-hover/key:opacity-100 transition-opacity"
                                            title="Copy API Key">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                                </path>
                                            </svg>
                                        </button>
                                        <button @click="confirmRegenerate(project)"
                                            class="text-gray-400 hover:text-orange-600 opacity-0 group-hover/key:opacity-100 transition-opacity"
                                            title="Regenerate API Key">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-center text-gray-600 font-medium">{{ project.bucket_count }}
                                </td>
                                <td class="px-6 py-4 text-center text-gray-600 font-medium">{{ project.file_count }}
                                </td>
                                <td class="px-6 py-4 text-center text-gray-600 font-medium">{{
                                    formatBytes(project.total_size) }}</td>
                                <td class="px-6 py-4 text-right text-gray-400 text-sm">
                                    {{ formatDate(project.created_at) }}
                                </td>
                                <td class="px-6 py-4 text-right flex justify-end gap-2">
                                    <button @click="syncProject(project)"
                                        class="text-blue-500 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition-opacity"
                                        title="Sync with MinIO" :disabled="syncingProjects.has(project._id)">
                                        <svg class="w-5 h-5" :class="{'animate-spin': syncingProjects.has(project._id)}"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                            </path>
                                        </svg>
                                    </button>
                                    <button @click="confirmDelete(project)"
                                        class="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity"
                                        title="Delete Project">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Card View -->
                <div class="md:hidden flex-1 overflow-y-auto p-4 space-y-4">
                    <div v-if="loading" class="text-center py-8 text-gray-400">Loading projects...</div>
                    <div v-else-if="projects.length === 0" class="text-center py-12 text-gray-500">
                        <svg class="w-10 h-10 text-gray-300 mx-auto mb-2" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                            </path>
                        </svg>
                        <p>No projects found. Create one to get started.</p>
                    </div>
                    <div v-else v-for="project in projects" :key="project._id"
                        class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 text-lg">{{ project.name }}</h3>
                                <p class="text-xs text-gray-500 font-mono mt-1">{{ project._id }}</p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="syncProject(project)" class="text-blue-500 hover:text-blue-700 p-2"
                                    title="Sync with MinIO" :disabled="syncingProjects.has(project._id)">
                                    <svg class="w-5 h-5" :class="{'animate-spin': syncingProjects.has(project._id)}"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                                <button @click="confirmDelete(project)" class="text-red-500 hover:text-red-700 p-2"
                                    title="Delete Project">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-2 mb-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">API Key</span>
                                <div class="flex items-center gap-2">
                                    <code
                                        class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600 font-mono">{{ project.api_key.substring(0, 12) }}...</code>
                                    <button @click="copyToClipboard(project.api_key)"
                                        class="text-gray-400 hover:text-blue-600" title="Copy API Key">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                    </button>
                                    <button @click="confirmRegenerate(project)"
                                        class="text-gray-400 hover:text-orange-600" title="Regenerate API Key">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 pt-3 border-t border-gray-100">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-1">Buckets</div>
                                <div class="text-lg font-semibold text-gray-900">{{ project.bucket_count }}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-1">Files</div>
                                <div class="text-lg font-semibold text-gray-900">{{ project.file_count }}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-1">Storage</div>
                                <div class="text-sm font-semibold text-gray-900">{{ formatBytes(project.total_size) }}
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400 text-right">
                            {{ formatDate(project.created_at) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Modal -->
        <div v-if="showCreateModal"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-40 p-4"
            @click.self="showCreateModal = false">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform transition-all scale-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Create New Project</h2>
                <form @submit.prevent="createProject">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                        <input type="text" v-model="newProjectName" placeholder="e.g. My Awesome App"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none"
                            autofocus>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="showCreateModal = false"
                            class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button>
                        <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium shadow-md shadow-blue-200 transition-all">Create</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div v-if="showDeleteModal"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-40 p-4"
            @click.self="showDeleteModal = false">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform transition-all scale-100">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Delete Project?</h2>
                        <p class="text-sm text-gray-500">This action cannot be undone</p>
                    </div>
                </div>

                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-red-800 font-medium mb-2">⚠️ Warning: All data will be permanently deleted
                    </p>
                    <ul class="text-sm text-red-700 space-y-1 ml-4 list-disc">
                        <li><strong>{{ projectToDelete?.bucket_count || 0 }}</strong> bucket(s)</li>
                        <li><strong>{{ projectToDelete?.file_count || 0 }}</strong> file(s)</li>
                        <li><strong>{{ formatBytes(projectToDelete?.total_size || 0) }}</strong> of storage</li>
                        <li>API key will be invalidated</li>
                        <li>All files will be removed from MinIO</li>
                    </ul>
                </div>

                <p class="text-gray-700 mb-6">
                    Are you sure you want to delete <strong class="text-gray-900">"{{ projectToDelete?.name
                        }}"</strong>?
                </p>

                <div class="flex justify-end gap-3">
                    <button type="button" @click="showDeleteModal = false"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button>
                    <button @click="deleteProject"
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium shadow-md shadow-red-200 transition-all">Delete
                        Project</button>
                </div>
            </div>
        </div>

        <!-- Regenerate API Key Modal -->
        <div v-if="showRegenerateModal"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-40 p-4"
            @click.self="showRegenerateModal = false">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform transition-all scale-100">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-orange-100 w-12 h-12 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Regenerate API Key?</h2>
                        <p class="text-sm text-gray-500">This will invalidate the old key</p>
                    </div>
                </div>

                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-orange-800 font-medium mb-2">⚠️ Warning: The old API key will stop working
                        immediately</p>
                    <ul class="text-sm text-orange-700 space-y-1 ml-4 list-disc">
                        <li>All applications using the old key will lose access</li>
                        <li>You'll need to update the key in all your apps</li>
                        <li>This action cannot be undone</li>
                    </ul>
                </div>

                <p class="text-gray-700 mb-6">
                    Are you sure you want to regenerate the API key for <strong class="text-gray-900">"{{
                        projectToRegenerate?.name }}"</strong>?
                </p>

                <div class="flex justify-end gap-3">
                    <button type="button" @click="showRegenerateModal = false"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button>
                    <button @click="regenerateApiKey"
                        class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-medium shadow-md shadow-orange-200 transition-all">Regenerate
                        Key</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const isAuthenticated = ref(false);
                const secretInput = ref('');
                const adminSecret = ref('');
                const projects = ref([]);
                const loading = ref(false);
                const showCreateModal = ref(false);
                const newProjectName = ref('');
                const toasts = ref([]);
                const showDeleteModal = ref(false);
                const projectToDelete = ref(null);
                const showRegenerateModal = ref(false);
                const projectToRegenerate = ref(null);

                const API_URL = '/admin/projects';

                const showToast = (message, type = 'success') => {
                    const id = Date.now();
                    toasts.value.push({ id, message, type });
                    setTimeout(() => {
                        toasts.value = toasts.value.filter(t => t.id !== id);
                    }, 3000);
                };

                const checkAuth = () => {
                    const stored = localStorage.getItem('admin_secret');
                    if (stored) {
                        adminSecret.value = stored;
                        isAuthenticated.value = true;
                        loadProjects();
                    }
                };

                const login = () => {
                    if (secretInput.value) {
                        localStorage.setItem('admin_secret', secretInput.value);
                        adminSecret.value = secretInput.value;
                        isAuthenticated.value = true;
                        loadProjects();
                    }
                };

                const logout = () => {
                    localStorage.removeItem('admin_secret');
                    isAuthenticated.value = false;
                    secretInput.value = '';
                    projects.value = [];
                };

                const loadProjects = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch(API_URL, {
                            headers: { 'X-Admin-Secret': adminSecret.value }
                        });
                        if (res.status === 401) {
                            showToast('Session expired', 'error');
                            logout();
                            return;
                        }
                        projects.value = await res.json();
                    } catch (e) {
                        showToast('Failed to load projects', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const createProject = async () => {
                    if (!newProjectName.value.trim()) return;

                    try {
                        const res = await fetch(API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Admin-Secret': adminSecret.value
                            },
                            body: JSON.stringify({ name: newProjectName.value })
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || 'Failed to create');
                        }

                        showToast('Project created successfully');
                        newProjectName.value = '';
                        showCreateModal.value = false;
                        loadProjects();
                    } catch (e) {
                        showToast(e.message, 'error');
                    }
                };

                const copyToClipboard = async (text) => {
                    try {
                        await navigator.clipboard.writeText(text);
                        showToast('API Key copied to clipboard');
                    } catch (e) {
                        showToast('Failed to copy', 'error');
                    }
                };

                const confirmDelete = (project) => {
                    projectToDelete.value = project;
                    showDeleteModal.value = true;
                };

                const deleteProject = async () => {
                    if (!projectToDelete.value) return;

                    try {
                        const res = await fetch(`${API_URL}/${projectToDelete.value._id}`, {
                            method: 'DELETE',
                            headers: {
                                'X-Admin-Secret': adminSecret.value
                            }
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || 'Failed to delete');
                        }

                        showToast('Project deleted successfully');
                        showDeleteModal.value = false;
                        projectToDelete.value = null;
                        loadProjects();
                    } catch (e) {
                        showToast(e.message, 'error');
                    }
                };

                const confirmRegenerate = (project) => {
                    projectToRegenerate.value = project;
                    showRegenerateModal.value = true;
                };

                const regenerateApiKey = async () => {
                    if (!projectToRegenerate.value) return;

                    try {
                        const res = await fetch(`${API_URL}/${projectToRegenerate.value._id}/regenerate-key`, {
                            method: 'PUT',
                            headers: {
                                'X-Admin-Secret': adminSecret.value
                            }
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || 'Failed to regenerate');
                        }

                        const data = await res.json();
                        showToast('API key regenerated successfully');
                        showRegenerateModal.value = false;
                        projectToRegenerate.value = null;
                        loadProjects();

                        // Auto-copy new key to clipboard
                        await navigator.clipboard.writeText(data.new_api_key);
                        showToast('New API key copied to clipboard');
                    } catch (e) {
                        showToast(e.message, 'error');
                    }
                };

                const syncingProjects = reactive(new Set());

                const syncProject = async (project) => {
                    if (syncingProjects.has(project._id)) return;
                    syncingProjects.add(project._id);

                    try {
                        const res = await fetch(`${API_URL}/${project._id}/sync`, {
                            method: 'POST',
                            headers: {
                                'X-Admin-Secret': adminSecret.value
                            }
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || 'Failed to sync');
                        }

                        const data = await res.json();
                        const stats = data.stats;

                        let msg = `Sync complete: +${stats.added}, -${stats.removed}, ~${stats.updated}`;
                        if (stats.errors.length > 0) {
                            msg += ` (${stats.errors.length} errors)`;
                            console.error('Sync errors:', stats.errors);
                            // Show first error in toast if available
                            if (stats.errors[0]) {
                                showToast(`Error: ${stats.errors[0]}`, 'error');
                            }
                        }

                        showToast(msg);
                        loadProjects();
                    } catch (e) {
                        showToast(e.message, 'error');
                    } finally {
                        syncingProjects.delete(project._id);
                    }
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString(undefined, {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
                };

                const formatBytes = (bytes, decimals = 2) => {
                    if (!+bytes) return '0 Bytes';
                    const k = 1024;
                    const dm = decimals < 0 ? 0 : decimals;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
                };

                onMounted(() => {
                    checkAuth();
                });

                return {
                    isAuthenticated,
                    secretInput,
                    projects,
                    loading,
                    showCreateModal,
                    newProjectName,
                    toasts,
                    showDeleteModal,
                    projectToDelete,
                    showRegenerateModal,
                    projectToRegenerate,
                    login,
                    logout,
                    createProject,
                    copyToClipboard,
                    confirmDelete,
                    deleteProject,
                    confirmRegenerate,
                    regenerateApiKey,
                    syncProject,
                    syncingProjects,
                    formatDate,
                    formatBytes
                };
            }
        }).mount('#app');
    </script>
</body>

</html>